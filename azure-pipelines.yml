trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: BE  # Provides AZURE_ARTIFACTS_PAT (Personal Access Token)

steps:
  # 1) Use Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Use Node.js 20.x'

  # 2) Authenticate with Azure Artifacts
  - script: |
      echo "Setting up npm authentication for Azure Artifacts..."
      mkdir -p ~/.npm
      echo "//pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/testfeed/npm/registry/:_authToken=$(AZURE_ARTIFACTS_PAT)" > ~/.npmrc
      npm set registry "https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/testfeed/npm/registry/"
      echo "npm registry set to Azure Artifacts feed."
    displayName: 'Authenticate with Azure Artifacts'

  # 3) Install dependencies & build TypeScript
  - script: |
      echo "Installing dependencies..."
      npm ci

      echo "Building TypeScript project..."
      npm run build
    displayName: 'Install & Build database-lib'

  # 4) Bump version & publish package
  - script: |
      echo "Bumping package version for database-lib..."
      npm version patch --no-git-tag-version

      echo "Publishing database-lib to Azure Artifacts..."
      npm publish --registry=https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/testfeed/npm/registry/
    displayName: 'Publish database-lib package'
